% Generated by roxygen2: do not edit by hand

\name{mcEM_step}
\alias{mcEM_step}
\alias{get_required_sampling_size}
\title{Monte Carlo EM helper utilities}
\usage{
mcEM_step(
  brts,
  pars,
  sample_size,
  soc,
  max_missing,
  max_lambda,
  lower_bound,
  upper_bound,
  xtol,
  tol,
  burnin,
  num_threads,
  return_trees = FALSE,
  verbose = FALSE,
  conditional = NULL,
  ...
)

get_required_sampling_size(M, tol = 0.05)
}
\arguments{
\item{brts}{Branching times (`numeric`) or a `phylo` object.}

\item{pars}{Numeric vector of current parameter estimates.}

\item{sample_size}{Monte Carlo sample size for each E-step replicate.}

\item{soc}{Number of species at the crown (2) or stem (1).}

\item{max_missing}{Maximum number of augmented tips allowed.}

\item{max_lambda}{Maximum speciation rate to explore.}

\item{lower_bound, upper_bound}{Numeric vectors of parameter bounds.}

\item{xtol}{Relative tolerance used by the inner optimiser.}

\item{tol}{Stopping tolerance on the standard error of the log-likelihood estimate.}

\item{burnin}{Number of MCEM iterations to discard when computing the SE.}

\item{num_threads}{Number of threads provided to the underlying C++ backend.}

\item{return_trees}{If TRUE, also copy simulated trees back to R.}

\item{verbose}{If TRUE, emit progress messages.}

\item{conditional}{Optional R callback applied to each parameter vector before simulation.}

\item{...}{Reserved for future extensions.}

\item{M}{Data frame of MCEM traces (with columns `fhat` and `sample_size`).}

\item{tol}{Target tolerance for the required sampling size helper.}
}
\value{
`mcEM_step()` returns a list with:
\itemize{
  \item `mcem`: data frame containing the parameter and log-likelihood trace;
  \item `pars`: final parameter estimates;
  \item `iterations`: number of MCEM iterations performed;
  \item `se`: estimated standard error of the log-likelihood.
}
`get_required_sampling_size()` returns the estimated sample size needed to reach the requested tolerance.
}
\description{
Low-level helpers used by the high-level \code{emphasis()} interface to run Monte Carlo EM refinement loops and adapt the Monte Carlo sample size.
}
\examples{
\dontrun{
  data(bird.orders, package = "ape")
  brts <- ape::branching.times(bird.orders)
  seed <- c(0.1, 0.2, -0.1, -0.05)

  trace <- mcEM_step(
    brts = brts,
    pars = seed,
    sample_size = 200,
    soc = 2,
    max_missing = 10000,
    max_lambda = 500,
    lower_bound = rep(-Inf, 4),
    upper_bound = rep(Inf, 4),
    xtol = 1e-3,
    tol = 0.1,
    burnin = 20,
    num_threads = 0
  )

  required <- get_required_sampling_size(trace$mcem, tol = 0.05)
}
}
